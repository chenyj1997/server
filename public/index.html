<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>永鑫资本系统 - 管理控制台</title>
    <link rel="stylesheet" href="/css/lib/bootstrap.min.css">
    <link href="/css/lib/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/admin.css" rel="stylesheet">
    
    <!-- 客服聊天样式优化 -->
    <style>
        /* 客服聊天消息样式优化 */
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
        }
        
        .chat-message-left {
            justify-content: flex-start;
        }
        
        .chat-message-right {
            justify-content: flex-end;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }
        
        .chat-message-left .message-bubble {
            border-bottom-left-radius: 4px;
        }
        
        .chat-message-right .message-bubble {
            border-bottom-right-radius: 4px;
        }
        
        /* 消息内容字体 - 主要信息，字体较大 */
        .message-bubble p {
            margin: 0 0 8px 0;
            font-size: 15px;
            line-height: 1.4;
            font-weight: 400;
        }
        
        /* 消息元信息 - 次要信息，字体较小 */
        .message-meta {
            font-size: 11px;
            line-height: 1.2;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        /* 图片消息样式 */
        .chat-image-preview {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .chat-image-preview:hover {
            transform: scale(1.02);
        }
        
        /* 聊天容器样式 */
        #chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        /* 滚动条样式 */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        #chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        #chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 用户标签样式优化 */
        .nav-link {
            font-size: 13px;
            padding: 8px 12px;
        }
        
        .nav-link .badge {
            font-size: 10px;
            padding: 2px 6px;
        }
        
        /* 关闭按钮样式 */
        .close-tab-btn {
            font-size: 14px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        
        .close-tab-btn:hover {
            opacity: 1;
            color: #dc3545 !important;
        }
    </style>
    
    <script>
        // 页面加载调试
        window.addEventListener('DOMContentLoaded', function() {
            // 检查页面元素
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
            }
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">永鑫资本系统管理控制台</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#info" id="nav-info">信息管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#users" id="nav-users">用户管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#notification" id="nav-notification">通知管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#transactions" id="nav-transactions">
                            交易审核
                            <span id="nav-transactions-badge" class="badge bg-danger rounded-pill" style="display:none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#system" id="nav-system">系统管理</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="nav-link" id="user-info">未登录</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="btn-logout">退出</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 主要内容区域 -->
        <div id="main-content">
            <!-- 信息管理区域 -->
            <div id="info-section" style="display: none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 me-3">信息列表</h5>
                        
                        <!-- 搜索和过滤区域 -->
                        <div class="row g-2 align-items-center flex-grow-1 me-3">
                            <div class="col-md-4">
                                <label for="info-search-input" class="form-label visually-hidden">搜索</label>
                                <input type="text" class="form-control form-control-sm" id="info-search-input" placeholder="搜索标题、姓名或摘要">
                            </div>
                             <div class="col-md-3">
                                <label for="info-status-filter" class="form-label visually-hidden">状态过滤</label>
                                <select class="form-select form-select-sm" id="info-status-filter">
                                    <option value="">所有状态</option>
                                    <option value="published">待售</option>
                                    <option value="sold">已售出</option>
                                    <option value="offline">已下架</option>
                                    <!-- 根据实际后端支持的状态添加更多选项 -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="info-date-start" class="form-label visually-hidden">开始日期</label>
                                <input type="date" class="form-control form-control-sm" id="info-date-start" title="开始日期">
                            </div>
                             <div class="col-md-2">
                                <label for="info-date-end" class="form-label visually-hidden">结束日期</label>
                                <input type="date" class="form-control form-control-sm" id="info-date-end" title="结束日期">
                            </div>
                        </div>

                        <button type="button" class="btn btn-sm btn-primary flex-shrink-0" id="btn-info-search">
                             <i class="bi bi-search"></i> 搜索/过滤
                         </button>

                        <button type="button" class="btn btn-sm btn-success flex-shrink-0 ms-2" id="add-info-btn">
                            <i class="bi bi-plus"></i> 新增信息
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- 加载提示 -->
                        <div id="info-list-loading" class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">加载信息列表中...</p>
                        </div>

                        <!-- 九宫格信息卡片容器 -->
                        <div id="info-list-container">
                            <!-- 信息卡片将通过JS动态填充 -->
                        </div>

                        <!-- 分页 -->
                        <nav aria-label="信息列表分页" class="mt-4">
                            <ul class="pagination justify-content-center"></ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- 用户管理区域 -->
            <div id="users-section" style="display: none;">
                <div class="d-flex justify-content-between mb-3">
                    <h3>用户列表</h3>
                    <div>
                        <button class="btn btn-success me-2" id="btn-add-user">添加会员</button>
                        <button class="btn btn-primary" id="btn-export-users">导出用户</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <!-- 搜索和筛选 -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="user-search" placeholder="搜索用户名/邮箱/手机号">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="user-role-filter">
                                    <option value="">所有角色</option>
                                    <option value="admin">管理员</option>
                                    <option value="user">普通用户</option>
                                    <option value="vip">VIP用户</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="user-status-filter">
                                    <option value="">所有状态</option>
                                    <option value="active">正常</option>
                                    <option value="disabled">禁用</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-secondary w-100" id="btn-reset-filter">重置筛选</button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" id="btn-manual-search">
                                    <i class="fas fa-search"></i> 手动搜索
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="users-table">
                                <thead>
                                    <tr>
                                        <th>邀请码</th>
                                        <th>用户名</th>
                                        <th>角色</th>
                                        <th>余额</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="users-list">
                                    <!-- 用户列表将通过JS动态填充 -->
                                </tbody>
                            </table>
                        </div>
                        <!-- 分页控件 -->
                        <nav>
                            <ul class="pagination justify-content-center" id="users-pagination">
                                <!-- 分页将通过JS动态填充 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- 通知管理区域 -->
            <div id="notification-section">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 me-3">通知管理</h5>
                        <!-- 新增通知按钮 -->
                        <button class="btn btn-success btn-sm" id="btn-new-notification"><i class="bi bi-plus"></i> 创建新通知</button>
                    </div>
                    <div class="card-body">
                        <!-- 搜索和过滤区域 -->
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control form-control-sm" id="notification-search" placeholder="搜索标题或内容">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="notification-type-filter">
                                    <option value="">所有类型</option>
                                    <option value="SYSTEM">系统通知</option>
                                    <option value="PAYMENT">支付通知</option>
                                    <option value="INCOME">收益通知</option>
                                    <option value="TRANSACTION">交易通知</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="notification-status-filter">
                                    <option value="">所有状态</option>
                                    <option value="ACTIVE">已发布</option>
                                    <option value="DRAFT">草稿</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary btn-sm w-100" onclick="notificationManager.applyFilters()">搜索/筛选</button>
                            </div>
                        </div>

                        <!-- 系统通知列表 -->
                        <h6>系统通知</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>标题</th>
                                        <th>类型</th>
                                        <th>状态</th>
                                        <th>发布时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="notification-list">
                                    <!-- 通知列表将由JS填充 -->
                                    <tr><td colspan="5" class="text-center text-muted py-4">加载中...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 交易通知列表 -->
                         <h6 class="mt-4">交易通知</h6>
                         <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>类型</th>
                                        <th>用户</th>
                                        <th>金额</th>
                                        <th>时间</th>
                                        <th>通知状态</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-notifications">
                                    <!-- 交易通知列表将由JS填充 -->
                                     <tr><td colspan="5" class="text-center text-muted py-4">加载中...</td></tr>
                                </tbody>
                             </table>
                         </div>

                    </div>
                </div>
            </div>

            <!-- 通知模态框 (用于创建和编辑系统通知) -->
            <div class="modal fade" id="notification-modal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="notificationModalLabel">创建/编辑系统通知</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="notification-form">
                                <input type="hidden" id="notification-id">
                                <div class="mb-3">
                                    <label for="notification-title" class="form-label">标题</label>
                                    <input type="text" class="form-control" id="notification-title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="notification-content" class="form-label">内容</label>
                                    <textarea class="form-control" id="notification-content" rows="5" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="notification-type" class="form-label">类型</label>
                                    <select class="form-select" id="notification-type" required>
                                        <option value="SYSTEM">系统通知</option>
                                        <option value="PAYMENT">支付通知</option>
                                        <option value="INCOME">收入通知</option>
                                        <option value="TRANSACTION">交易通知</option>
                                    </select>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="notification-active" checked>
                                    <label class="form-check-label" for="notification-active">立即发布</label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" id="btn-save-notification">保存通知</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 交易审核区域 -->
            <div id="transactions-section" class="page-section" style="display: none;">
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <h3>交易审核</h3>
                        <small class="text-muted">管理充值、提现和转账交易</small>
                    </div>
                    <div>
                        <button class="btn btn-primary me-2" id="btn-export-transactions">
                            <i class="bi bi-download"></i> 导出记录
                        </button>
                        <button class="btn btn-info me-2" id="btn-recharge-paths">
                            <i class="bi bi-gear"></i> 充值路径设置
                        </button>
                        <button class="btn btn-outline-secondary" id="btn-refresh-transactions">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                    </div>
                </div>
                
                <!-- 搜索和筛选 -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="search-input" placeholder="搜索交易ID或用户名">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="type-filter">
                                    <option value="">所有类型</option>
                                    <option value="recharge">充值</option>
                                    <option value="withdraw">提现</option>
                                    <option value="transfer">转账</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="status-filter">
                                    <option value="">所有状态</option>
                                    <option value="pending">待处理</option>
                                    <option value="completed">已完成</option>
                                    <option value="failed">失败</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <input type="date" class="form-control" id="date-start">
                                    <span class="input-group-text">至</span>
                                    <input type="date" class="form-control" id="date-end">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-secondary w-100" id="btn-search">
                                    <i class="bi bi-search"></i> 搜索
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 钱包明细和列表 -->
                <div class="row mb-4">
                    <!-- 今日明细 -->
                    <div class="col-md-3">
                        <div class="card bg-info bg-opacity-25 h-100">
                            <div class="card-body">
                                <h5 class="card-title">今日明细</h5>
                                <div class="mt-3">
                                    <p>充值金额</p>
                                    <h4>¥<span id="today-income">0</span></h4>
                                    <p>提现金额</p>
                                    <h4>¥<span id="today-expense">0</span></h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 昨日明细 -->
                    <div class="col-md-3">
                        <div class="card bg-warning bg-opacity-25 h-100">
                            <div class="card-body">
                                <h5 class="card-title">昨日明细</h5>
                                <div class="mt-3">
                                    <p>充值金额</p>
                                    <h4>¥<span id="yesterday-income">0</span></h4>
                                    <p>提现金额</p>
                                    <h4>¥<span id="yesterday-expense">0</span></h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 本周明细 -->
                    <div class="col-md-3">
                        <div class="card bg-success bg-opacity-25 h-100">
                            <div class="card-body">
                                <h5 class="card-title">本周明细</h5>
                                <div class="mt-3">
                                    <p>充值金额</p>
                                    <h4>¥<span id="week-income">0</span></h4>
                                    <p>提现金额</p>
                                    <h4>¥<span id="week-expense">0</span></h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 本月明细 -->
                    <div class="col-md-3">
                        <div class="card bg-danger bg-opacity-25 h-100">
                            <div class="card-body">
                                <h5 class="card-title">本月明细</h5>
                                <div class="mt-3">
                                    <p>充值金额</p>
                                    <h4>¥<span id="month-income">0</span></h4>
                                    <p>提现金额</p>
                                    <h4>¥<span id="month-expense">0</span></h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 交易列表 -->
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>交易ID</th>
                                        <th>类型</th>
                                        <th>金额</th>
                                        <th>用户</th>
                                        <th>状态</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-list">
                                    <!-- 交易列表将在这里动态渲染 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 分页 -->
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页将在这里动态渲染 -->
                    </ul>
                </nav>
            </div>

            <!-- 新增系统管理区域 -->
            <div id="system-section" class="page-section" style="display: none;">
                <h3>系统管理</h3>
                
                <!-- 返利设置 Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="bi bi-percent"></i> 返利设置</h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3 align-items-center">
                            <div class="col-md-5">
                                <label for="rebate-percentage" class="form-label fw-bold">邀请购买返利百分比 (%)</label>
                                <input type="number" class="form-control" id="rebate-percentage" min="0" max="100" step="0.1" placeholder="例如: 5 (表示5%)">
                                <small class="form-text text-muted">用户完成"购买信息"类型的交易时，其邀请人将获得此百分比的金额返利。</small>
                            </div>
                            <div class="col-md-3">
                                <label for="rebate-min-amount" class="form-label fw-bold">最低返利金额 (可选)</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" id="rebate-min-amount" min="0" step="0.01" placeholder="例如: 0.01">
                                </div>
                                <small class="form-text text-muted">单次返利金额若低于此值，则不发放。</small>
                            </div>
                            <div class="col-md-2 d-flex align-self-end">
                                <button class="btn btn-primary w-100" id="btn-save-rebate-settings"><i class="bi bi-save"></i> 保存设置</button>
                            </div>
                        </div>
                        <div id="rebate-settings-feedback" class="mt-2"></div>
                    </div>
                </div>

                <!-- 广告路径设置 Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="bi bi-megaphone"></i> 广告管理</h4>
                        <button class="btn btn-success btn-sm" id="btn-add-ad">
                            <i class="bi bi-plus"></i> 添加广告
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- 广告列表 -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>序号</th>
                                        <th>预览图</th>
                                        <th>跳转链接</th>
                                        <th>状态</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="ad-list">
                                    <!-- 广告列表将通过JS动态填充 -->
                                </tbody>
                            </table>
                            </div>
                            </div>
                        </div>

                <!-- 广告编辑模态框 -->
                <div class="modal fade" id="ad-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">添加/编辑广告</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                            <div class="modal-body">
                                <form id="ad-form">
                                    <input type="hidden" id="ad-id">
                                    <div class="mb-3">
                                        <label for="ad-path-input" class="form-label">跳转链接</label>
                                        <input type="url" class="form-control" id="ad-path-input" placeholder="例如: https://example.com/ad-page" required>
                        </div>
                                    <div class="mb-3">
                                        <label for="ad-image-upload" class="form-label">广告图片</label>
                                        <input type="file" class="form-control" id="ad-image-upload" accept="image/*" required>
                                        <div id="ad-image-preview" class="mt-2">
                                            <img src="" alt="广告预览" style="max-width: 200px; max-height: 150px; display: none;">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="ad-status" checked>
                                            <label class="form-check-label" for="ad-status">启用广告</label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="btn-save-ad">保存</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 文件/数据清理 Card -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="bi bi-trash3"></i> 文件/数据清理</h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="system-date-filter" class="form-label">早于日期:</label>
                                <input type="date" class="form-control" id="system-date-filter">
                            </div>
                            <div class="col-md-4">
                                <label for="system-search" class="form-label">搜索文件名:</label>
                                <input type="text" class="form-control" id="system-search" placeholder="输入文件名或关键字">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-primary me-2" id="btn-scan-files">
                                    <i class="bi bi-search"></i> 扫描未使用文件
                                </button>
                                <button class="btn btn-danger" id="btn-clean-files" disabled>
                                     <i class="bi bi-trash"></i> 清理扫描结果
                                </button>
                            </div>
                        </div>
                        <hr>
                        <h5>扫描结果:</h5>
                        <div id="system-scan-results">
                            <p class="text-center text-muted">请点击"扫描未使用文件"按钮开始。</p>
                        </div>
                    </div>
                </div>

                <!-- 图片文件夹管理 Card -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="bi bi-folder-image"></i> 图片文件夹管理</h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="cover-folder-path" class="form-label fw-bold">封面图片队列</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="cover-folder-path" placeholder="显示队列状态" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="btn-select-cover-folder">
                                        <i class="bi bi-images"></i> 加载图片
                                    </button>
                                </div>
                                <small class="form-text text-muted">一次性加载多张图片到待用队列，供新增信息时自动上传</small>
                                <div class="mt-2">
                                    <span class="badge bg-info" id="cover-folder-status">未设置</span>
                                    <span class="badge bg-secondary ms-2" id="cover-folder-count">0 张图片</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="additional-folder-path" class="form-label fw-bold">更多照片队列</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="additional-folder-path" placeholder="显示队列状态" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="btn-select-additional-folder">
                                        <i class="bi bi-images"></i> 加载图片
                                    </button>
                                </div>
                                <small class="form-text text-muted">一次性加载多张图片到待用队列，供新增信息时自动上传</small>
                                <div class="mt-2">
                                    <span class="badge bg-info" id="additional-folder-status">未设置</span>
                                    <span class="badge bg-secondary ms-2" id="additional-folder-count">0 张图片</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto-delete-used-images" checked>
                                    <label class="form-check-label" for="auto-delete-used-images">
                                        使用后自动删除图片
                                    </label>
                                </div>
                                <small class="form-text text-muted">选中后，图片上传成功后会从原文件夹中删除，避免重复使用</small>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="random-select-images" checked>
                                    <label class="form-check-label" for="random-select-images">
                                        随机选择图片
                                    </label>
                                </div>
                                <small class="form-text text-muted">选中后，每次编辑信息时随机选择图片，否则按文件名顺序选择</small>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="cover-images-count" class="form-label">封面图片数量</label>
                                <input type="number" class="form-control" id="cover-images-count" min="1" max="5" value="1">
                                <small class="form-text text-muted">每次编辑信息时自动选择的封面图片数量</small>
                            </div>
                            <div class="col-md-6">
                                <label for="additional-images-count" class="form-label">更多照片数量</label>
                                <input type="number" class="form-control" id="additional-images-count" min="1" max="10" value="1">
                                <small class="form-text text-muted">每次编辑信息时自动选择的更多照片数量</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <button class="btn btn-primary me-2" id="btn-save-folder-settings">
                                    <i class="bi bi-save"></i> 保存设置
                                </button>
                                <button class="btn btn-info me-2" id="btn-refresh-folder-status">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新状态
                                </button>
                                <button class="btn btn-warning" id="btn-test-auto-select">
                                    <i class="bi bi-play"></i> 测试自动选择
                                </button>
                            </div>
                        </div>

                        <div id="folder-settings-feedback" class="mt-3"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 信息编辑模态框 -->
    <div class="modal fade" id="info-modal" tabindex="-1" aria-labelledby="info-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="info-modal-label">信息编辑</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="info-form">
                        <input type="hidden" id="info-id">
                        
                        <!-- 基本信息部分 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">基本信息</h6>
                                <button type="button" class="btn btn-sm btn-info" id="btn-random-fill-info">
                                    <i class="bi bi-shuffle"></i> 随机填充
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="name" class="form-label">姓名</label>
                                        <input type="text" class="form-control" id="name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="phone" class="form-label">手机号码</label>
                                        <input type="tel" class="form-control" id="phone" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="age" class="form-label">年龄</label>
                                        <input type="number" class="form-control" id="age" min="18" max="100" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="occupation" class="form-label">职业</label>
                                        <input type="text" class="form-control" id="occupation" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 借款信息部分 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">借款信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="loan-amount" class="form-label">借款金额</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" class="form-control" id="loan-amount" min="0" step="100" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="repayment-amount" class="form-label">还款金额</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" class="form-control" id="repayment-amount" min="0" step="100" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="loan-period" class="form-label">借款周期</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="loan-period" min="1" required>
                                            <span class="input-group-text">天</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 图片上传部分 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">图片上传</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="cover-image" class="form-label">封面图片</label>
                                    <input type="file" class="form-control" id="cover-image" accept="image/*" required>
                                    <div id="cover-preview" class="mt-2">
                                        <!-- 预览图片将在这里动态添加 -->
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="additional-images" class="form-label">更多照片</label>
                                    <input type="file" class="form-control" id="additional-images" accept="image/*" multiple>
                                    <div id="additional-images-preview" class="mt-2 d-flex flex-wrap gap-2">
                                        <!-- 预览图片将在这里动态添加 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-info-btn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户个人中心界面 -->
    <div id="user-container" style="display: none;">
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>个人中心</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action active" id="nav-user-home">首页</a>
                        <a href="#" class="list-group-item list-group-item-action" id="nav-user-profile">个人资料</a>
                        <a href="#" class="list-group-item list-group-item-action" id="nav-user-wallet">我的钱包</a>
                        <a href="#" class="list-group-item list-group-item-action text-danger" id="user-btn-logout">退出登录</a>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <!-- 用户首页 -->
                <div id="user-home-section">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5>信息列表</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group" id="user-info-list">
                                <!-- 信息列表将通过JS动态填充 -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 个人资料 -->
                <div id="user-profile-section" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5>个人资料</h5>
                        </div>
                        <div class="card-body">
                            <div id="profile-result" class="alert" style="display: none;"></div>
                            <form id="profile-form">
                                <div class="mb-3">
                                    <label for="profile-username" class="form-label">用户名</label>
                                    <input type="text" class="form-control" id="profile-username" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="profile-email" class="form-label">邮箱</label>
                                    <input type="email" class="form-control" id="profile-email">
                                </div>
                                <div class="mb-3">
                                    <label for="profile-phone" class="form-label">手机号</label>
                                    <input type="tel" class="form-control" id="profile-phone">
                                </div>
                                <button type="submit" class="btn btn-primary">保存修改</button>
                            </form>

                            <hr class="my-4">

                            <h5>修改密码</h5>
                            <form id="password-form">
                                <input type="hidden" id="password-form-username" name="username" autocomplete="username">
                                <div class="mb-3">
                                    <label for="current-password" class="form-label">当前密码</label>
                                    <input type="password" class="form-control" id="current-password" required autocomplete="current-password">
                                </div>
                                <div class="mb-3">
                                    <label for="change-new-password" class="form-label">新密码</label>
                                    <input type="password" class="form-control" id="change-new-password" required autocomplete="new-password">
                                    <small class="form-text text-muted">密码长度至少6个字符</small>
                                </div>
                                <div class="mb-3">
                                    <label for="confirm-new-password" class="form-label">确认新密码</label>
                                    <input type="password" class="form-control" id="confirm-new-password" required autocomplete="new-password">
                                </div>
                                <button type="submit" class="btn btn-danger">修改密码</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- 钱包管理 -->
                <div id="user-wallet-section" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5>我的钱包</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <h5 class="mb-0 me-2">当前余额:</h5>
                                        <h2 class="mb-0 text-primary" id="user-wallet-balance">¥0.00</h2>
                                    </div>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <button class="btn btn-success me-2" id="btn-user-recharge">充值</button>
                                    <button class="btn btn-outline-primary" id="btn-user-withdraw">提现</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5>交易记录</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>类型</th>
                                            <th>金额</th>
                                            <th>说明</th>
                                            <th>状态</th>
                                            <th>时间</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-transactions-list">
                                        <!-- 交易记录通过JS动态填充 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 充值模态框 -->
    <div class="modal fade" id="recharge-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">账户充值</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="recharge-form">
                        <div class="mb-3">
                            <label for="recharge-amount" class="form-label">充值金额</label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="number" class="form-control" id="recharge-amount" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="recharge-description" class="form-label">备注（选填）</label>
                            <input type="text" class="form-control" id="recharge-description">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-confirm-recharge">确认充值</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加会员模态框 -->
    <div class="modal fade" id="add-user-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加会员</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-user-form">
                        <div class="mb-3">
                            <label for="admin-new-username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="admin-new-username" name="username" required autocomplete="username">
                        </div>
                        <div class="mb-3">
                            <label for="admin-new-user-password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="admin-new-user-password" name="password" required autocomplete="new-password">
                            <small class="form-text text-muted">密码长度至少6个字符</small>
                        </div>
                        <div class="mb-3">
                            <label for="admin-new-email" class="form-label">邮箱</label>
                            <input type="email" class="form-control" id="admin-new-email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="admin-new-phone" class="form-label">手机号</label>
                            <input type="text" class="form-control" id="admin-new-phone" name="phone">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-save-user">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户详情模态框 -->
    <div class="modal fade" id="user-detail-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">用户详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4 id="detail-user-name">用户名</h4>
                            <p class="text-muted">ID: <span id="detail-user-id"></span></p>
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="badge p-2" id="detail-user-role">角色</span>
                            <span class="badge p-2" id="detail-user-status">状态</span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">邮箱</label>
                                <p id="detail-user-email">-</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">手机号</label>
                                <p id="detail-user-phone">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">账户余额</label>
                                <p id="detail-user-balance">¥0.00</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">注册时间</label>
                                <p id="detail-user-created">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">邀请码</label>
                                <p id="detail-user-invite-code">-</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">推荐人</label>
                                <p id="detail-user-referrer">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">最后登录时间</label>
                                <p id="detail-user-last-login">-</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">信息更新时间</label>
                                <p id="detail-user-updated-at">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                         <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">支付密码状态</label>
                                <p id="detail-user-payment-password-set">-</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- 其他字段或留空 -->
                        </div>
                    </div>

                    <hr class="my-4">
                    
                    <h5 class="mb-3">邀请的用户</h5>
                    <div id="detail-user-invited-users-container" style="max-height: 300px; overflow-y: auto;">
                        <p id="detail-user-invited-users-loading"><em>正在加载邀请用户列表...</em></p>
                        <table class="table table-sm table-striped table-hover d-none"> <!-- Initially hidden -->
                            <thead class="table-light">
                                <tr>
                                    <th>用户ID</th>
                                    <th>用户名</th>
                                    <th>注册时间</th>
                                    <th>状态</th>
                                    <th>邮箱</th>
                                    <th>手机</th>
                                </tr>
                            </thead>
                            <tbody id="detail-user-invited-users-table-body">
                                <!-- 邀请的用户将在这里填充 -->
                            </tbody>
                        </table>
                        <p id="detail-user-invited-users-empty" class="text-center" style="display:none;"><em>该用户暂未邀请其他用户。</em></p>
                    </div>

                    <!-- 新增：受邀用户的购买记录区域 (默认隐藏) -->
                    <div id="detail-invited-user-purchases-container" style="display: none;">
                        <hr class="my-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 id="invited-user-purchases-title">购买记录</h5>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-back-to-invited-list">
                                <i class="bi bi-arrow-left"></i> 返回邀请列表
                            </button>
                        </div>
                        <div style="max-height: 280px; overflow-y: auto;">
                            <p id="invited-user-purchases-loading"><em>正在加载购买记录...</em></p>
                            <table class="table table-sm table-striped table-hover d-none"> <!-- Initially hidden -->
                                <thead class="table-light">
                                    <tr>
                                        <th>日期</th>
                                        <th>购买内容/备注</th>
                                        <th>金额</th>
                                        <th>状态</th>
                                        <th>详情/备注</th> 
                                    </tr>
                                </thead>
                                <tbody id="invited-user-purchases-table-body">
                                    <!-- 购买记录将在这里填充 -->
                                </tbody>
                            </table>
                            <p id="invited-user-purchases-empty" class="text-center" style="display:none;"><em>该用户暂无购买记录。</em></p>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="detail-btn-edit">编辑用户</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 信息详情与留言模态框 -->
    <div class="modal fade" id="info-detail-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">信息详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="info-detail-content"><!-- 信息内容 --></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 充值路径设置模态框 -->
    <div class="modal fade" id="recharge-path-modal" tabindex="-1" aria-labelledby="recharge-path-modal-title" aria-modal="true" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recharge-path-modal-title">添加充值路径</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="recharge-path-form" onsubmit="return false;">
                        <input type="hidden" id="recharge-path-id" name="id">
                        <div class="mb-3">
                            <label for="recharge-path-icon" class="form-label">上传图标</label>
                            <input type="file" class="form-control" id="recharge-path-icon" name="icon" accept="image/*">
                            <div class="mt-2" id="icon-preview"></div>
                            <small class="form-text text-muted">上传图标将显示在APP充值界面，建议使用清晰的支付方式图标</small>
                        </div>
                        <div class="mb-3">
                            <label for="recharge-path-name" class="form-label">充值名称</label>
                            <input type="text" class="form-control" id="recharge-path-name" name="name" required placeholder="例如：支付宝充值、微信支付等">
                        </div>
                        <input type="hidden" id="recharge-path-type" name="type" value="other">
                        <div class="mb-3">
                            <label for="recharge-path-account" class="form-label">收款账号</label>
                            <input type="text" class="form-control" id="recharge-path-account" name="account" required>
                        </div>
                        <div class="mb-3">
                            <label for="recharge-path-receiver" class="form-label">收款人</label>
                            <input type="text" class="form-control" id="recharge-path-receiver" name="receiver" required>
                        </div>
                        <div class="mb-3">
                            <label for="recharge-path-qrcode" class="form-label">收款二维码</label>
                            <input type="file" class="form-control" id="recharge-path-qrcode" name="qrCode" accept="image/*" required>
                            <div class="mt-2" id="qrcode-preview"></div>
                            <small class="form-text text-muted">上传收款二维码，用户可以通过扫描二维码进行支付</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-save-recharge-path">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 充值路径列表模态框 -->
    <div class="modal fade" id="recharge-paths-list-modal" tabindex="-1" aria-labelledby="recharge-paths-list-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recharge-paths-list-modal-title">充值路径管理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 添加新充值路径按钮 -->
                    <button class="btn btn-success mb-3" id="btn-add-new-recharge-path-in-list-modal">
                        <i class="fas fa-plus"></i> 添加新的充值路径
                    </button>
                    
                    <!-- 充值路径列表显示区域 -->
                    <div class="list-group" id="recharge-paths-ul">
                        <!-- 列表项将由JavaScript动态生成 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改用户角色模态框 -->
    <div class="modal fade" id="edit-user-role-modal" tabindex="-1" aria-labelledby="editUserRoleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserRoleModalLabel">修改用户角色</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-user-role-id">
                    <div class="mb-3">
                        <label for="new-user-role" class="form-label">选择新角色</label>
                        <select class="form-select" id="new-user-role">
                            <option value="user">普通用户</option>
                            <option value="vip">VIP用户</option>
                            <option value="admin">管理员</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-save-user-role">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 管理员客服对话模态框 -->
    <div class="modal fade" id="admin-customer-chat-modal" tabindex="-1" aria-labelledby="adminCustomerChatModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- 顶部标题栏 -->
                <div class="modal-header">
                    <h5 class="modal-title" id="adminCustomerChatModalLabel">客服管理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- 用户tab横向排列，使用Bootstrap nav-tabs -->
                    <ul class="nav nav-tabs" id="user-tabs" role="tablist">
                        <!-- 用户tab按钮将通过JS动态插入，每个tab对应一个用户 -->
                    </ul>
                    <!-- 聊天内容区域 -->
                    <div id="chat-content" class="p-3" style="background:#fff; border-left:1px solid #eee; border-right:1px solid #eee;">
                        <div id="chat-messages">
                            <p class="text-muted text-center mt-3">请选择一个用户开始聊天</p>
                        </div>
                    </div>
                </div>
                <!-- 底部输入框和发送按钮 -->
                <div class="modal-footer d-flex align-items-center" style="gap:8px;">
                    <input type="text" class="form-control" id="admin-message-input" placeholder="请输入" autocomplete="off">
                    <input type="file" id="admin-image-upload-input" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-secondary" id="button-upload-image-admin" title="发送图片">
                        <i class="bi bi-image"></i>
                    </button>
                    <button type="button" class="btn btn-primary" id="button-send-admin">发送</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载中提示 -->
    <div class="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <!-- 提示框 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- 客服图标 (用于弹出管理员客服模态框) -->
    <div id="customer-service-icon-container" style="position: fixed; bottom: 130px; right: 130px; z-index: 1000; cursor: pointer;">
        <img src="/images/customer-service-icon.png" alt="客服" style="display: block; width: 50px; height: 50px;">
        <span id="unread-messages-badge" style="position: absolute; top: -5px; right: -5px; background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; display: none;">0</span>
    </div>

    <!-- 交易详情模态框 -->
    <div class="modal fade" id="transaction-detail-modal" tabindex="-1" aria-labelledby="transactionDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionDetailModalLabel">交易详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="transaction-detail-content">
                    <!-- 交易详情将由JS填充 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本 -->
    <!-- 先加载第三方库 -->
    <script src="/js/lib/bootstrap.bundle.min.js"></script>
    <script src="/js/lib/all.min.js"></script>

    <!-- 加载工具类 -->
    <script src="/js/utils/ui.js"></script>
    <script src="/js/utils/api.js"></script>
    <script src="/js/utils/auth.js"></script>
    
    <!-- 加载业务模块 -->
    <script src="/js/admin/recharge-paths.js"></script>
    <script src="/js/admin/customer_service_manager.js"></script>
    <script src="/js/admin/user-manager.js"></script>
    <script src="/js/admin/notification-manager.js"></script>
    <script src="/js/admin/transaction-manager.js"></script>
    <script src="/js/admin/system-manager.js"></script>
    <script src="/js/admin/folder-manager.js"></script>
    <script src="/js/admin/info.js"></script>
    <script src="/js/admin/index.js"></script>
    <script>
        // 页面加载完成后立即执行的脚本
        document.addEventListener('DOMContentLoaded', function() {
            
            // 检查 Bootstrap 是否正确加载
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap 未正确加载');
                return;
            }
            
            // 显示调试信息
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                let html = '<strong>页面状态:</strong><br>';
                html += '加载时间: ' + new Date().toLocaleString() + '<br>';
                html += '登录状态: ' + (localStorage.getItem('token') ? '已登录' : '未登录') + '<br>';
                html += 'Bootstrap状态: ' + (typeof bootstrap !== 'undefined' ? '已加载' : '未加载') + '<br>';
                // 检查管理员版 infoManager 是否加载
                html += '管理员版info管理器: ' + (window.infoManager && window.infoManager._isAdminVersion ? '已加载' : '未加载') + '<br>';
                // 检查通知管理器是否加载
                html += '通知管理器: ' + (window.notificationManager ? '已加载' : '未加载') + '<br>';
                
                // 检查主要元素
                const mainContent = document.getElementById('main-content');
                html += '主内容区域: ' + (mainContent ? '存在' : '不存在') + '<br>';
                if (mainContent) {
                    html += '显示状态: ' + (mainContent.style.display || '默认') + '<br>';
                    mainContent.style.display = 'block';
                    html += '已强制显示主内容区域';
                }
                
                // 检查新增信息按钮
                const addInfoBtn = document.getElementById('add-info-btn');
                if (addInfoBtn) {
                    html += '<br>新增信息按钮: 存在';
                    
                    // 直接绑定点击事件，调用管理员版 infoManager 的 showInfoModal
                    addInfoBtn.onclick = function() {
                         if (window.infoManager && window.infoManager._isAdminVersion && typeof window.infoManager.showInfoModal === 'function') {
                             window.infoManager.showInfoModal();
                         } else {
                             if (window.ui) {
                                 window.ui.showError('无法打开新增信息表单');
                             }
                         }
                     };
                    html += ' (已绑定事件)';
                } else {
                    html += '<br>新增信息按钮: 不存在';
                }
                
                debugInfo.innerHTML = html;
            }

            // 绑定导航事件
            const navNotification = document.getElementById('nav-notification');
            if (navNotification) {
                navNotification.addEventListener('click', function(e) {
                    e.preventDefault();
                    // 隐藏其他区域
                    document.querySelectorAll('.page-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    // 显示通知区域
                    const notificationSection = document.getElementById('notification-section');
                    if (notificationSection) {
                        notificationSection.style.display = 'block';
                        // 使用 initNotificationPage 而不是 init，避免重复初始化
                        if (window.notificationManager && typeof window.notificationManager.initNotificationPage === 'function') {
                            window.notificationManager.initNotificationPage();
                        }
                    }
                });
            }

            // Event listener for the random fill button in the info modal
            const btnRandomFillInfo = document.getElementById('btn-random-fill-info');
            if (btnRandomFillInfo) {
                btnRandomFillInfo.addEventListener('click', async () => {
                    try {
                        if (window.ui && window.ui.showLoading) {
                             window.ui.showLoading('正在获取随机信息...');
                        }

                        const response = await fetch('/api/admin/generate-random-info', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || '无法获取随机信息');
                        }

                        const result = await response.json();

                        if (result.success && result.data) {
                            const data = result.data;
                            document.getElementById('name').value = data.姓名 || '';
                            document.getElementById('phone').value = data.手机 || '';
                            document.getElementById('age').value = data.年龄 || '';
                            document.getElementById('occupation').value = data.职业 || '';
                            
                            if (window.ui && window.ui.showSuccess) {
                                window.ui.showSuccess('随机信息已填充！');
                            } else {
                                alert('随机信息已填充！');
                            }
                        } else {
                            throw new Error(result.message || '获取随机信息返回格式错误');
                        }
                    } catch (error) {
                        console.error('随机填充信息错误:', error);
                        if (window.ui && window.ui.showError) {
                            window.ui.showError(`随机填充失败: ${error.message}`);
                        } else {
                            alert(`随机填充失败: ${error.message}`);
                        }
                    } finally {
                        if (window.ui && window.ui.hideLoading) {
                            window.ui.hideLoading();
                        }
                    }
                });
            }

            // 页面加载后监听用户第一次点击，激活音频上下文
            function activateAudioContextOnce() {
                const audio = document.getElementById('notify-audio');
                if (audio) {
                    const originalVolume = audio.volume;
                    audio.volume = 0;
                    audio.play().then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.volume = originalVolume;
                    }).catch(() => {});
                }
                document.body.removeEventListener('click', activateAudioContextOnce);
            }
            document.body.addEventListener('click', activateAudioContextOnce);
        });
    </script>

    <!-- User Transactions Modal -->
    <div class="modal fade" id="userTransactionsModal" tabindex="-1" aria-labelledby="userTransactionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userTransactionsModalLabel">用户资金明细 - <span id="modalUserName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="transactionTypeFilter" class="form-label">类型</label>
                            <select id="transactionTypeFilter" class="form-select form-select-sm">
                                <option value="">全部</option>
                                <option value="recharge">充值</option>
                                <option value="withdraw">提现</option>
                                <option value="purchase">购买信息</option>
                                <option value="repay">还款</option>
                                <option value="transfer_out">转出</option>
                                <option value="transfer_in">转入</option>
                                <option value="refund">退款</option>
                                <option value="reward">奖励</option>
                                <option value="fee">手续费</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="transactionStatusFilter" class="form-label">状态</label>
                            <select id="transactionStatusFilter" class="form-select form-select-sm">
                                <option value="">全部</option>
                                <option value="pending">待审核</option>
                                <option value="approved">已通过</option>
                                <option value="rejected">已拒绝</option>
                                <option value="completed">已完成</option>
                                <option value="failed">失败</option>
                                <option value="cancelled">已取消</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="transactionStartDateFilter" class="form-label">开始日期</label>
                            <input type="date" id="transactionStartDateFilter" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-3">
                            <label for="transactionEndDateFilter" class="form-label">结束日期</label>
                            <input type="date" id="transactionEndDateFilter" class="form-control form-control-sm">
                        </div>
                    </div>
                    <button type="button" id="applyTransactionFilters" class="btn btn-primary btn-sm mb-3">查询</button>
                    <div id="userTransactionsTableContainer">
                        <table class="table table-sm table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>类型</th>
                                    <th>金额</th>
                                    <th>交易后余额</th>
                                    <th>状态</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody id="user-transactions-tbody">
                                <tr><td colspan="6" class="text-center">请查询用户数据...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <span id="transactionsPaginationInfo" class="me-auto"></span>
                    <button type="button" class="btn btn-secondary btn-sm" id="prevTransactionsPage" disabled>上一页</button>
                    <button type="button" class="btn btn-primary btn-sm" id="nextTransactionsPage" disabled>下一页</button>
                    <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="notify-audio" src="https://ppt-mp3cdn.hrxz.com/d/file/filemp3/hrxz.com-gvvcvjm0nl254028.mp3" preload="auto"></audio>
</body>
</html> 
